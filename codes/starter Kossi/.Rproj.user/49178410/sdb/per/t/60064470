{
    "contents" : "# Project: Olivier_tarif_prov\n# \n# Author: kossi\n###############################################################################\n\n# Chargement des packages necessaires\n\nChargePkg <- function(x){ # fonction pour charger plus facilement les packages\n\tx <- as.character(x)\n\tif(!require(x, character.only = TRUE)){\n# \t\tinstall.packages(pkgs = x, repos = \"http://cran.r-project.org\")\n\t\tinstall.packages(pkgs = x, dependencies = TRUE)\n\t\trequire(x, character.only = TRUE)\n\t}\n}\n\npkgs  <- list(\"jsonlite\", \"ggplot2\", \"plyr\", \"tree\", \"shiny\")\n\nlapply(pkgs, ChargePkg)\n\nPlotVarVersusNbsinistre <- function(varSinistre){\n# Impact de l'age du conducteur (variable quantitative) sur la frequence de sinistres\n\tif(varSinistre == \"ageconducteur\"){\n\t\t\n\t\treg1 <- glm(nombre~as.factor(ageconducteur),offset=log(exposition),data=BASEN,family=poisson(link=\"log\"))\n\t\tage=seq(20,80)\n\t\tprednb1 <- predict(reg1,newdata=data.frame(ageconducteur=age,exposition=1),type=\"response\")\n\t\t\n\t\tp <- ggplot(data = data.frame(age = age, prednb1 = prednb1), aes(x = age, y = prednb1))\n\t\tp <- p + geom_point(size = 3)\n\t\tp <- p + xlab(\"Age du conducteur\") + ylab(\"Nombre de sinistres\")\n\t\t\n\t\treg2 <- glm(nombre~ageconducteur,offset=log(exposition),data=BASEN,family=poisson(link=\"log\"))\n\t\tprednb2 <- predict(reg2,newdata=data.frame(ageconducteur=age,exposition=1),type=\"response\")\n\t\t\n\t\tp <- p + geom_line(data = data.frame(age = age, prednb2 = prednb2), aes(x = age, y = prednb2), color = \"blue\")\n\t\t\n\t\tp\t\n\t# Impact de l'age du vehicule (variable quantitative) sur la frequence de sinistres\n\t} else if(varSinistre == \"agevehicule\"){\n\t\t\n\t\treg3 <- glm(nombre~as.factor(agevehicule),offset=log(exposition),data=BASEN,family=poisson(link=\"log\"))\n\t\tagev=seq(0,40)\n\t\tprednb3<-predict(reg3,newdata=data.frame(agevehicule=agev,exposition=1),type=\"response\")\n\t\t\n\t\tp <- ggplot(data = data.frame(agev = agev, prednb3 = prednb3), aes(x = agev, y = prednb3))\n\t\tp <- p + geom_point(size = 3)\n\t\tp <- p + xlab(\"Age du véhicule\") + ylab(\"Nombre de sinistres\")\n\t\t\n\t\treg4<-glm(nombre~agevehicule,offset=log(exposition),data=BASEN,family=poisson(link=\"log\"))\n\t\tprednb4<-predict(reg4,newdata=data.frame(agevehicule=agev,exposition=1),type=\"response\")\n\t\t\n\t\tp <- p + geom_line(data = data.frame(agev = agev, prednb4 = prednb4), aes(x = agev, y = prednb4), color = \"blue\")\n\t\tp\n\t# Impact de anciennete du permis (variable quantitative) sur la frequence de sinistres\t\n\t} else if(varSinistre == \"agepermis\") {\n\t\t\n\t\treg5<-glm(nombre~as.factor(agepermis),offset=log(exposition),data=BASEN,family=poisson(link=\"log\"))\n\t\tagep=seq(0,40)\n\t\tprednb5<-predict(reg5,newdata=data.frame(agepermis=agep,exposition=1),type=\"response\")\n\t\t\n\t\tp <- ggplot(data = data.frame(agep = agep, prednb5 = prednb5), aes(x = agep, y = prednb5))\n\t\tp <- p + geom_point(size = 3)\n\t\tp <- p + xlab(\"Age du permis\") + ylab(\"Nombre de sinistres\")\n\t\t\n\t\t\n\t\treg6<-glm(nombre~ agepermis,offset=log(exposition),data=BASEN,family=poisson(link=\"log\"))\n\t\tprednb6<-predict(reg6,newdata=data.frame(agepermis =agep,exposition=1),type=\"response\")\n\t\t\n\t\tp <- p + geom_line(data = data.frame(agep = agep, prednb6 = prednb6), aes(x = agep, y = prednb6), color = \"blue\")\n\t\tp\n\t# Impact du type du vehicule (variable qualitative) sur la frequence de sinistres\t\t\n\t} else if(varSinistre == \"voiture\"){\n\t\t\n\t\ttypeveh <- ddply(BASEN, ~voiture, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = typeveh, aes(x = voiture, y = Nb_sinistres, fill = voiture))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\t\n\t# Impact du sexe du conducteur principal sur la frequence de sinistres\t\n\t}else if(varSinistre == \"sexeconducteur\"){\n\t\t\n\t\tsexeCond <- ddply(BASEN, ~sexeconducteur, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = sexeCond, aes(x = sexeconducteur, y = Nb_sinistres, fill = sexeconducteur))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\n\t# Impact de la situation familiale du conducteur sur la frequence de sinistres\n\t}else if(varSinistre == \"situationfamiliale\"){\n\t\t\n\t\tsitFamilyCond <- ddply(BASEN, ~situationfamiliale, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = sitFamilyCond, aes(x = situationfamiliale, y = Nb_sinistres, fill = situationfamiliale))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\t\n\t# Impact la lieu d'habitation sur la frequence de sinistres\n\t}else if(varSinistre == \"habitation\"){\n\t\t\n\t\thabitationCond <- ddply(BASEN, ~habitation, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = habitationCond, aes(x = habitation, y = Nb_sinistres, fill = habitation))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\n\t# Impact le statut d'habitation (locataire ou locataire) sur la frequence de sinistres\n\t}else if(varSinistre == \"proprietaire\"){\n\t\t\n\t\tproprietaireCond <- ddply(BASEN, ~proprietaire, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = proprietaireCond, aes(x = proprietaire, y = Nb_sinistres, fill = proprietaire))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\n\t# Impact la frequence de paiement de la prime sur la frequence de sinistres\n\t} else if(varSinistre == \"payment\"){\n\t\t\n\t\tpaymentCond <- ddply(BASEN, ~payment, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = paymentCond, aes(x = payment, y = Nb_sinistres, fill = payment))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\n\t# Impact le poids du vehicule sur la frequence de sinistres\n\t}else if(varSinistre == \"poids\"){\n\t\t\n\t\tpoidsCond <- ddply(BASEN, ~poids, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = poidsCond, aes(x = poids, y = Nb_sinistres, fill = poids))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\n\t# Impact la marque du vehicule sur la frequence de sinistres\n\t}else if(varSinistre == \"marque\"){\n\t\t\n\t\tmarqueCond <- ddply(BASEN, ~marque, summarise, Nb_sinistres = (sum(nombre) / sum(exposition)))\n\t\tp <- ggplot(data = marqueCond, aes(x = marque, y = Nb_sinistres, fill = marque))\n\t\tp <- p + geom_bar(stat = \"identity\")\n\t\tp <- p + geom_text(aes(label=round(Nb_sinistres, 3)), vjust=-0.2, colour=\"red\", size = 3.5)\n\t\tp\n\t} else{}\t\n\t\n}\n\n\n\nPlotVarVersusCout <- function(varCout){\n\t\n\t# Etude des couts individuels en fonction du sexe du conducteur\n\tif(varCout == \"sexeconducteur\"){\n\t\tp <- ggplot(data = BASEY, aes(x = sexeconducteur, y = cout, fill = sexeconducteur))\n\t\tp <- p + geom_boxplot() \n\t\tp <- p + coord_flip() # Renverser le graphique\n\t\tp <- p + scale_y_log10()\n\t\tp\n\t# Etude des couts individuels en fonction de la situation familiale du conducteur\n\t}else if(varCout == \"situationfamiliale\"){\n\t\tp <- ggplot(data = BASEY, aes(x = situationfamiliale, y = cout, fill = situationfamiliale))\n\t\tp <- p + geom_boxplot() \n\t\tp <- p + coord_flip() # Renverser le graphique\n\t\tp <- p + scale_y_log10()\n\t\tp\n\t# Etude des couts individuels en fonction du lieu d'habitation\n\t}else if(varCout == \"habitation\"){\n\t\tp <- ggplot(data = BASEY, aes(x = habitation, y = cout, fill = habitation))\n\t\tp <- p + geom_boxplot() \n\t\tp <- p + coord_flip() # Renverser le graphique\n\t\tp <- p + scale_y_log10()\n\t\tp\t\n\t# Etude des couts individuels en fonction du statut d'habitation (locataire, proprietaire)\n\t}else if(varCout == \"proprietaire\"){\n\t\tp <- ggplot(data = BASEY, aes(x = proprietaire, y = cout, fill = proprietaire))\n\t\tp <- p + geom_boxplot() \n\t\tp <- p + coord_flip() # Renverser le graphique\n\t\tp <- p + scale_y_log10()\n\t\tp\n\t# Etude des couts individuels en fonction du mode de paiement de la prime\n\t}else if(varCout == \"payment\"){\n\t\tp <- ggplot(data = BASEY, aes(x = payment, y = cout, fill = payment))\n\t\tp <- p + geom_boxplot() \n\t\tp <- p + coord_flip() # Renverser le graphique\n\t\tp <- p + scale_y_log10()\n\t\tp\n\t# cout de sinistres versus age du conducteur\n\t}else if(varCout == \"ageconducteur\"){\n\t\tregr1=glm(cout~as.factor(ageconducteur),data=BASEY,family=Gamma(link=\"log\"))\n\t\tage=c(seq(22,29),seq(31,80))\n\t\tprednb1=predict(regr1,newdata=data.frame(ageconducteur=age),type=\"response\")\n\t\t\n\t\tp <- ggplot(data = data.frame(age = age, prednb1 = prednb1), aes(x = age, y = prednb1))\n\t\tp <- p + geom_point(size = 3)\n\t\t\n\t\t\n\t\tregr2=glm(cout~ageconducteur,data=BASEY,family=Gamma(link=\"log\"))\n\t\tprednb2=predict(regr2,newdata=data.frame(ageconducteur=age),type=\"response\")\n\t\t\n\t\tp <- p + geom_line(data = data.frame(age = age, prednb2 = prednb2), aes(x = age, y = prednb2), color = \"blue\")\n\t\tp\n\t}else if(varCout == \"agevehicule\"){\n\t\tregr3=glm(cout~as.factor(agevehicule),data=BASEY,family=Gamma(link=\"log\"))\n\t\tagev=seq(0,29)\n\t\tprednb3=predict(regr3,newdata=data.frame(agevehicule=agev),type=\"response\")\n\t\t\n\t\tp <- ggplot(data = data.frame(agev = agev, prednb3 = prednb3), aes(x = agev, y = prednb3))\n\t\tp <- p + geom_point(size = 3)\n\t\t\n\t\t\n\t\tregr4=glm(cout~agevehicule,data=BASEY,family=Gamma(link=\"log\"))\n\t\tprednb4=predict(regr4,newdata=data.frame(agevehicule=agev),type=\"response\")\n\t\t\n\t\tp <- p + geom_line(data = data.frame(agev = agev, prednb4 = prednb4), aes(x = agev, y = prednb4), color = \"blue\")\n\t\tp\n\t}else{}\n}\n\nModele <- function(choixModele){\n\tif(choixModele == \"Modele_frequence\"){\n\t\t\n\t\treg13=glm(nombre~ ageconducteur+proprietaire+ payment+situationfamiliale+ agepermis+marque+voiture+ sexeconducteur+\n\t\t\t\t  habitation+proprietaire,offset=log(exposition),data=BASEN,family=poisson(link=\"log\"))\n        summary(reg13)\n\t}else if(choixModele == \"Modele_cout\"){\n\t\tregr5=glm(cout~.-exposition,data=BASEY,family=Gamma(link=\"log\"))\n\t\tsummary(regr5)\n\t\t\n\t}else{}\n\t\t\n\t\n}\n\n\n\n# modeleArbre <- function(){\n#\t\n#\tarbre=rpart(nombre~ageconducteur+agepermis+sexeconducteur+situationfamiliale+habitation+agevehicule+proprietaire+payment+\n#\t\t\t\t\tmarque+poids+usage+voiture,data=BASEN)\n#\tplot(arbre)\n#\ttext(arbre)\n# }\n\narbre <- function(){\n\t\n\tarbre=tree(nombre~ageconducteur+agepermis+sexeconducteur+situationfamiliale+habitation+agevehicule+proprietaire+payment+\n\t\t\t   marque+poids+usage+voiture,data=BASEN,split=\"gini\", mincut = 3500)\n\tplot(arbre)\n\ttext(arbre)\n\t\n}\nshinyServer(\n\t\tfunction(input,output)\n\t\t{\n\t\t\t\n# Affichage de la base de sinistres\t\t\t\n\t\t\toutput$baseSinistre <- renderDataTable({\n\t\t\t\t\t\t\n\t\t\t\t\t\tBASEN\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t}, options = list(aLengthMenu = c(5, 30, 50), iDisplayLength = 5))\n\t\t\t\n# Affichage de la base de coût\n\t\t\toutput$baseCout <- renderDataTable({\n\t\t\t\t\t\t\n\t\t\t\t\t\tBASEY\n\t\t\t\t\t\t\n\t\t\t\t\t}, options = list(aLengthMenu = c(5, 30, 50), iDisplayLength = 5))\n\t\t\t\n# Affichage influence variables tarifaires sur nombre de sinistres\n\t\t\toutput$influenceSinistre <- renderPlot({\n\t\t\t\t\t\tp  <- PlotVarVersusNbsinistre(input$variable_sinistre)\n\t\t\t\t\t\t\n\t\t\t\t\t\tprint(p)\t\t\n\t\t\t\t\t})\n\t\t\t\n# Affichage influence variables tarifaires sur cout de sinistres\n\t\t\toutput$influenceCout <- renderPlot({\n\t\t\t\t\t\tp  <- PlotVarVersusCout(input$variable_cout)\n\t\t\t\t\t\t# if(input$logScale) p <- p + scale_y_log10()\n\t\t\t\t\t\tprint(p)\t\t\n\t\t\t\t\t})\n\t\t\t\n# Affichage influence variables tarifaires sur cout de sinistres\n\t\t\toutput$Modeles <- renderPrint({\n\t\t\t\t\t\t\t\n\t\t\t\t\t\tModele(input$Model)\n\t\t\t\t\t})\n\t\t\toutput$Arbre <- renderPlot({\n\t\t\t\t\t\t\n\t\t\t\t\t\tarbre()\n\n\t\t\t\t\t})\n\t\t\t\n\t\t}\n)\n\n",
    "created" : 1482324067841.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "669179608",
    "id" : "60064470",
    "lastKnownWriteTime" : 1482324840,
    "path" : "Y:/Forsides France/06_Solo/Yohann LE FAOU/mission_forsides/pricing_game_2017/codes/starter Kossi/server.R",
    "project_path" : "server.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}